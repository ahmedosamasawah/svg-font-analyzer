[tools]
python = { version = "3.12", venv = ".venv" }
lefthook = 'latest'
node = '22'
pnpm = '10'
uv = 'latest'
jq = 'latest'

[tasks.install-backend-deps]
alias = 'ibd'
description = "Install backend dependencies using uv"
run = "uv pip install -e .[dev]"
sources = ["pyproject.toml", "uv.lock"]
outputs = [".venv"]
depends = ["setup-venv"]

[tasks.install-frontend-deps]
alias = "ifd"
description = "Install frontend dependencies"
run = "pnpm i"
sources = ["pnpm-lock.yaml"]
outputs = ["node_modules"]

[tasks.install]
alias = "i"
description = "Install all project dependencies"
depends = ["install-backend-deps", "install-frontend-deps"]

[tasks.api]
description = "Start the backend server"
run = 'uvicorn api.main:app --reload'
depends = ['install-backend-deps']

[tasks.dev-client]
description = "Start the frontend server"
run = 'pnpm dev'
depends = ['install-frontend-deps']

[tasks.dev]
alias = 'start'
description = 'Start client and API'
depends = ['api', 'dev-client']

[tasks.build_frontend]
description = "Build the frontend for production"
run = 'pnpm i && pnpm build'
sources = ["package.json", "pnpm-lock.yaml", "src/**/*", "public/**/*", "vite.config.ts"]
outputs = ["dist"]

[tasks.deploy_setup]
description = "Set up the production server for deployment"
run = '''
ssh $DEPLOY_HOST '
  set -e
  mkdir -p /srv/apps/svg-font-analyzer/client
  cd /srv/apps/svg-font-analyzer
  cat - > svg-font-analyzer.service
  echo '[env]' >> .mise.local.toml
  sudo systemctl enable $PWD/svg-font-analyzer.service
' < svg-font-analyzer.service
echo "Populate `/srv/apps/svg-font-analyzer/.mise.local.toml` with env vars"
'''

[tasks.deploy]
description = "Deploy the application to the production server"
depends = ['build_frontend']
run = '''
  scp -C -r dist/index.html public/* $DEPLOY_HOST:/srv/apps/svg-font-analyzer/client/

  git archive HEAD .mise.toml uv.lock pyproject.toml api | ssh $DEPLOY_HOST '
    set -e
    cd /srv/apps/svg-font-analyzer/
    tar -xf -
    mise i
  '
  ssh $DEPLOY_HOST 'sudo service svg-font-analyzer restart'
'''

[tasks.lefthook-init]
description = "Initialize lefthook"
run = "lefthook install"

[tasks.setup-venv]
description = "Create Python virtual environment if it does not exist"
run = "uv venv"
outputs = [".venv/pyvenv.cfg"]

[env]
VITE_PORT = 5020
VITE_API_URL = "http://localhost:8000"